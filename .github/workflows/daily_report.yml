name: Daily Ping Report

on:
  schedule:
    - cron: "0 12 * * *"  # å°ç£æ™‚é–“ 20:00 (UTC+8)
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq msmtp

      - name: Fetch workflow runs
        id: get_runs
        env:
          GITHUB_TOKEN: ${{ secrets.REPORT_PAT }}
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          echo "ğŸ” Fetching runs for: $TODAY (UTC)"

          API_URL="https://api.github.com/repos/${{ github.repository }}/actions/workflows/157651133/runs?created=$TODAY&per_page=100"
          
          # æ·»åŠ è©³ç´°éŒ¯èª¤æ—¥èªŒ
          curl -v -s -f \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL" > runs.json 2> curl-debug.log

          if [ $? -ne 0 ]; then
            echo "::error::API Request Failed. Debug Info:"
            cat curl-debug.log
            exit 1
          fi

      - name: Generate report
        run: |
          # ç²¾ç¢ºçµ±è¨ˆè¨ˆç®—
          TOTAL=$(jq '.workflow_runs | length' runs.json)
          SUCCESS=$(jq '[.workflow_runs[] | select(.conclusion == "success")] | length' runs.json)
          FAIL=$(jq '[.workflow_runs[] | select(.conclusion == "failure")] | length' runs.json)

          # æ‰‹æ©Ÿå„ªå…ˆå ±å‘Šæ ¼å¼
          echo "# ğŸ“± PingåŸ·è¡Œå ±å‘Š - $(date -u +"%Y-%m-%d")" > report.md
          echo "**ğŸŸ¢ æˆåŠŸï¼š$SUCCESS** | **ğŸ”´ å¤±æ•—ï¼š$FAIL** | **ç¸½æ•¸ï¼š$TOTAL**" >> report.md
          echo "" >> report.md

          # éŸ¿æ‡‰å¼è¡¨æ ¼ (ç§»å‹•ç«¯è‡ªå‹•æ›è¡Œ)
          echo "### æœ€è¿‘5æ¬¡åŸ·è¡Œ" >> report.md
          echo "| ç·¨è™Ÿ | æ™‚é–“ | ç‹€æ…‹ | ç”¨æ™‚ |" >> report.md
          echo "|------|------|:----:|-----:|" >> report.md
          
          jq -r '
            .workflow_runs[0:5][] |  # åªé¡¯ç¤ºæœ€æ–°5ç­†
            [
              "#\(.run_number)",
              (.run_started_at | sub("\\.[0-9]+Z$"; "Z") | fromdateiso8601 + (8*3600) | strftime("%H:%M")),
              (if .conclusion == "success" then "ğŸŸ¢" else "ğŸ”´" end),
              (
                ((.updated_at | fromdateiso8601) - (.run_started_at | fromdateiso8601)) |
                if . >= 60 then "\((. /60)|floor)åˆ†" else "\(.)ç§’" end
              )
            ] | join("|")
          ' runs.json | while read -r line; do
            echo "|$line|" >> report.md
          done

          # å®Œæ•´è¨˜éŒ„æŠ˜ç–Šå€
          echo "" >> report.md
          echo "<details>" >> report.md
          echo "<summary>æŸ¥çœ‹å®Œæ•´è¨˜éŒ„ (å…±$TOTALç­†)</summary>" >> report.md
          echo "" >> report.md
          
          jq -r '
            .workflow_runs[] |
            "| \(.run_number) | \(.run_started_at | sub("\\.[0-9]+Z$"; "Z") | fromdateiso8601 + (8*3600) | strftime("%H:%M")) | \(
              if .conclusion == "success" then "ğŸŸ¢" else "ğŸ”´" end
            ) | \(
              ((.updated_at | fromdateiso8601) - (.run_started_at | fromdateiso8601)) |
              if . >= 60 then "\((. /60)|floor)åˆ†" else "\(.)ç§’" end
            ) | [é€£çµ](\(.html_url)) |"
          ' runs.json >> report.md
          
          echo "</details>" >> report.md

      - name: Send email
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          # å»ºç«‹ msmtp é…ç½®æª”æ¡ˆ
          echo "account default" > ~/.msmtprc
          echo "host smtp.gmail.com" >> ~/.msmtprc
          echo "port 587" >> ~/.msmtprc
          echo "auth on" >> ~/.msmtprc
          echo "user $EMAIL_USER" >> ~/.msmtprc
          echo "password $EMAIL_PASS" >> ~/.msmtprc
          echo "tls on" >> ~/.msmtprc
          echo "tls_starttls on" >> ~/.msmtprc
          echo "logfile ~/.msmtp.log" >> ~/.msmtprc
          chmod 600 ~/.msmtprc

          # ä¿®æ­£çµ±è¨ˆæ•¸æ“š
          BODY=$(sed -e 's/ğŸŸ¢/<span style="color:#2ecc71;font-weight:bold;">â—<\/span>/g' \
                     -e 's/ğŸ”´/<span style="color:#e74c3c;font-weight:bold;">â—<\/span>/g' \
                     -e 's/# \(.*\)/<h2 style="color:#34495e; font-size:20px; margin-bottom:8px;">\1<\/h2>/g' \
                     -e 's/### \(.*\)/<h3 style="color:#2c3e50; font-size:16px; margin-bottom:6px;">\1<\/h3>/g' \
                     -e 's/|\(.*\)|\(.*\)|\(.*\)|\(.*\)|/<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;"><span>\1<\/span><span>\2<\/span><span>\3<\/span><span>\4<\/span><\/div>/g' \
                     report.md)

          {
            echo "To: $EMAIL_TO"
            echo "From: $EMAIL_USER"
            echo "Subject: [Pingå ±å‘Š] $(date -u +"%Y-%m-%d")"
            echo "Content-Type: text/html; charset=UTF-8"
            echo ""
            echo "<!DOCTYPE html>"
            echo "<html>"
            echo "<head><meta name='viewport' content='width=device-width, initial-scale=1'></head>"
            echo "<body style='font-family:-apple-system, BlinkMacSystemFont, sans-serif; max-width:600px; margin:0 auto; padding:16px; line-height:1.6;'>"
            echo "<div style='background:#f9f9f9; padding:16px; border-radius:8px;'>"
            echo "$BODY"
            echo "</div>"
            echo "</body></html>"
          } | msmtp -t