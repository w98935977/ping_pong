name: Daily Ping Report

on:
  schedule:
    - cron: "0 12 * * *"  # å°ç£æ™‚é–“ 20:00 (UTC+8)
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq msmtp

      - name: Fetch workflow runs
        id: get_runs
        env:
          GITHUB_TOKEN: ${{ secrets.REPORT_PAT }}
        run: |
          # è¨ˆç®—æ˜¨å¤©å’Œä»Šå¤©çš„æ—¥æœŸï¼ˆå°ç£æ™‚é–“ï¼‰
          YESTERDAY=$(date -u -d "yesterday +8 hours" +"%Y-%m-%d")
          TODAY=$(date -u -d "today +8 hours" +"%Y-%m-%d")
          echo "ğŸ” Fetching runs from: $YESTERDAY 20:00 to $TODAY 20:00 (å°ç£æ™‚é–“)"

          # API è«‹æ±‚ URLï¼ŒæŠ“å–æ˜¨å¤©æ™šä¸Š 20:00 åˆ°ä»Šå¤©æ™šä¸Š 20:00 çš„è¨˜éŒ„
          API_URL="https://api.github.com/repos/${{ github.repository }}/actions/workflows/157651133/runs?per_page=100"

          # åˆå§‹åŒ–ç©ºçš„ JSON æ–‡ä»¶
          echo '[]' > runs.json

          # æŠ“å–æ˜¨å¤©çš„è¨˜éŒ„
          curl -s -f \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL&created=$YESTERDAY" | jq '.workflow_runs' > yesterday_runs.json

          # æŠ“å–ä»Šå¤©çš„è¨˜éŒ„
          curl -s -f \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL&created=$TODAY" | jq '.workflow_runs' > today_runs.json

          # åˆä½µæ˜¨å¤©å’Œä»Šå¤©çš„è¨˜éŒ„
          jq -s 'add' yesterday_runs.json today_runs.json > runs.json

          # ç¢ºèªæ˜¯å¦æˆåŠŸæŠ“å–
          if [ "$(jq 'length' runs.json)" -eq 0 ]; then
            echo "::error::No workflow runs found for the specified time range."
            exit 1
          fi

      - name: Generate report
        run: |
          # è¨ˆç®—å°ç£æ™‚é–“ç¾åœ¨ã€ä»Šå¤©20:00ã€æ˜¨å¤©20:00
          TW_NOW=$(date -u -d '+8 hours' +%s)
          TW_TODAY_20=$(date -u -d '20:00 +8 hours' +%s)
          if [ "$TW_NOW" -lt "$TW_TODAY_20" ]; then
            TW_YESTERDAY_20=$(date -u -d 'yesterday 20:00 +8 hours' +%s)
          else
            TW_YESTERDAY_20=$TW_TODAY_20
            TW_TODAY_20=$(date -u -d 'tomorrow 20:00 +8 hours' +%s)
          fi

          # çµ±è¨ˆ
          TOTAL=$(jq 'length' runs.json)
          SUCCESS=$(jq '[.[] | select(.conclusion == "success")] | length' runs.json)
          FAIL=$(jq '[.[] | select(.conclusion == "failure")] | length' runs.json)

          # å ±å‘Šæ¨™é¡Œèˆ‡çµ±è¨ˆæ‘˜è¦
          echo "<h1>ğŸ“Š Ping åŸ·è¡Œå ±å‘Š - $(date -u -d '+8 hours' +'%Y-%m-%d')</h1>" > report.html
          echo "<p>æ“·å–æ™‚é–“æ®µï¼š$(date -d @$TW_YESTERDAY_20 +'%Y-%m-%d %H:%M') è‡³ $(date -d @$TW_TODAY_20 +'%Y-%m-%d %H:%M') (å°ç£æ™‚é–“)</p>" >> report.html
          echo "<p><strong>æˆåŠŸï¼š${SUCCESS} æ¬¡</strong></p>" >> report.html
          echo "<p><strong>å¤±æ•—ï¼š${FAIL} æ¬¡</strong></p>" >> report.html
          echo "<p><strong>ç¸½åŸ·è¡Œï¼š${TOTAL} æ¬¡</strong></p>" >> report.html

          echo "<hr>" >> report.html

          # ä»Šå¤©çš„è¨˜éŒ„
          echo "<h2>ä»Šå¤©çš„è¨˜éŒ„</h2>" >> report.html
          echo "<table>" >> report.html
          echo "<thead><tr><th>ç·¨è™Ÿ</th><th>æ™‚é–“ (å°ç£æ™‚é–“)</th><th>ç‹€æ…‹</th></tr></thead>" >> report.html
          echo "<tbody>" >> report.html

          jq -r --argjson start "$TW_YESTERDAY_20" --argjson end "$TW_TODAY_20" '
            sort_by(.run_started_at) | reverse |
            map(select(
              (.run_started_at|type == "string") and
              (.run_started_at|test("T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$")) and
              ((.run_started_at | fromdateiso8601 + 8*3600) >= $start and
               (.run_started_at | fromdateiso8601 + 8*3600) < $end)
            ))[] |
            [
              "#\(.run_number)",
              (.run_started_at | sub("\\.[0-9]+Z$"; "Z") | fromdateiso8601 + (8*3600) | strftime("%Y-%m-%d %H:%M")),
              (if .conclusion == "success" then "ğŸŸ¢ æˆåŠŸ" else "ğŸ”´ å¤±æ•—" end),
              (if .conclusion == "failure" then "<a href=\"\(.html_url)\" style=\"color:#e74c3c;\">é€£çµ</a>" else "" end)
            ] | @tsv
          ' runs.json | while IFS=$'\t' read -r run_number time status link; do
            echo "<tr>" >> report.html
            echo "<td>${run_number}</td>" >> report.html
            echo "<td>${time}</td>" >> report.html
            echo "<td>${status} ${link}</td>" >> report.html
            echo "</tr>" >> report.html
          done

          echo "</tbody></table>" >> report.html

          # æ˜¨å¤©çš„è¨˜éŒ„
          echo "<h2>æ˜¨å¤©çš„è¨˜éŒ„</h2>" >> report.html
          echo "<table>" >> report.html
          echo "<thead><tr><th>ç·¨è™Ÿ</th><th>æ™‚é–“ (å°ç£æ™‚é–“)</th><th>ç‹€æ…‹</th></tr></thead>" >> report.html
          echo "<tbody>" >> report.html

          jq -r --argjson start "$(($TW_YESTERDAY_20-86400))" --argjson end "$TW_YESTERDAY_20" '
            sort_by(.run_started_at) | reverse |
            map(select(
              (.run_started_at|type == "string") and
              (.run_started_at|test("T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$")) and
              ((.run_started_at | fromdateiso8601 + 8*3600) >= $start and
               (.run_started_at | fromdateiso8601 + 8*3600) < $end)
            ))[] |
            [
              "#\(.run_number)",
              (.run_started_at | sub("\\.[0-9]+Z$"; "Z") | fromdateiso8601 + (8*3600) | strftime("%Y-%m-%d %H:%M")),
              (if .conclusion == "success" then "ğŸŸ¢ æˆåŠŸ" else "ğŸ”´ å¤±æ•—" end),
              (if .conclusion == "failure" then "<a href=\"\(.html_url)\" style=\"color:#e74c3c;\">é€£çµ</a>" else "" end)
            ] | @tsv
          ' runs.json | while IFS=$'\t' read -r run_number time status link; do
            echo "<tr>" >> report.html
            echo "<td>${run_number}</td>" >> report.html
            echo "<td>${time}</td>" >> report.html
            echo "<td>${status} ${link}</td>" >> report.html
            echo "</tr>" >> report.html
          done

          echo "</tbody></table>" >> report.html

      - name: Send email
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          # å»ºç«‹ msmtp é…ç½®æª”æ¡ˆ
          echo "account default" > ~/.msmtprc
          echo "host smtp.gmail.com" >> ~/.msmtprc
          echo "port 587" >> ~/.msmtprc
          echo "auth on" >> ~/.msmtprc
          echo "user $EMAIL_USER" >> ~/.msmtprc
          echo "password $EMAIL_PASS" >> ~/.msmtprc
          echo "tls on" >> ~/.msmtprc
          echo "tls_starttls on" >> ~/.msmtprc
          echo "from $EMAIL_USER" >> ~/.msmtprc  # æ·»åŠ  envelope-from åœ°å€
          echo "logfile ~/.msmtp.log" >> ~/.msmtprc
          chmod 600 ~/.msmtprc

          # ä¿®æ­£çµ±è¨ˆæ•¸æ“š
          BODY=$(sed -e 's/ğŸŸ¢/<span style="color:#2ecc71;font-weight:bold;">â—<\/span>/g' \
                     -e 's/ğŸ”´/<span style="color:#e74c3c;font-weight:bold;">â—<\/span>/g' \
                     -e 's/<h1>/<h1 style="color:#34495e; font-size:24px; margin-bottom:16px;">/g' \
                     -e 's/<h2>/<h2 style="color:#2c3e50; font-size:20px; margin-bottom:12px;">/g' \
                     -e 's/<p>/<p style="margin:8px 0;">/g' \
                     report.html)

          {
            echo "To: $EMAIL_TO"
            echo "From: $EMAIL_USER"
            echo "Subject: [Pingå ±å‘Š] $(date -u +"%Y-%m-%d")"
            echo "Content-Type: text/html; charset=UTF-8"
            echo ""
            echo "<!DOCTYPE html>"
            echo "<html>"
            echo "<head><meta name='viewport' content='width=device-width, initial-scale=1'></head>"
            echo "<body style='font-family:-apple-system, BlinkMacSystemFont, sans-serif; max-width:600px; margin:0 auto; padding:16px; line-height:1.6;'>"
            echo "<div style='background:#f9f9f9; padding:16px; border-radius:8px;'>"
            echo "$BODY"
            echo "</div>"
            echo "</body></html>"
          } | msmtp -t