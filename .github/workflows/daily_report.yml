name: Daily Ping Report

on:
  schedule:
    - cron: "0 12 * * *"  # 台灣時間 20:00
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq msmtp

      - name: Fetch today's workflow runs
        id: get_runs
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          echo "🔍 Today is: $TODAY (UTC)"
          RESP=$(curl -s \
            -H "Authorization: token ${{ secrets.REPORT_PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/157651133/runs?per_page=100")
          echo "$RESP" > runs.json

          TOTAL=$(jq '[.workflow_runs[] | select(.created_at | strings | startswith("'"$TODAY"'"))] | length' runs.json)
          SUCCESS=$(jq '[.workflow_runs[] | select(.created_at | strings | startswith("'"$TODAY"'") and .conclusion=="success")] | length' runs.json)
          FAIL=$(jq '[.workflow_runs[] | select(.created_at | strings | startswith("'"$TODAY"'") and .conclusion=="failure")] | length' runs.json)

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "fail=$FAIL" >> $GITHUB_OUTPUT

          echo "📅 Ping Report for $TODAY (UTC+8):" > report.md
          echo "- Total runs: $TOTAL" >> report.md
          echo "- Success:    $SUCCESS" >> report.md
          echo "- Failures:   $FAIL" >> report.md
          echo "" >> report.md
          echo "✅ Success runs:" >> report.md
          jq -r '.workflow_runs[] | select(.created_at | strings | startswith("'"$TODAY"'") and .conclusion=="success") | .html_url' runs.json >> report.md

      - name: Show report
        run: cat report.md

      - name: Email report
        run: |
          cat <<EOF > ~/.msmtprc
defaults
auth           on
tls            on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
account        gmail
host           smtp.gmail.com
port           587
from           ${{ secrets.EMAIL_USER }}
user           ${{ secrets.EMAIL_USER }}
password       ${{ secrets.EMAIL_PASS }}
account default : gmail
EOF

          chmod 600 ~/.msmtprc

          cat <<EOF | msmtp --debug --from=default -t
To: ${{ secrets.EMAIL_TO }}
From: ${{ secrets.EMAIL_USER }}
Subject: Daily Ping Report - $(date -u +"%Y-%m-%d")
Content-Type: text/plain

$(cat report.md)
EOF
