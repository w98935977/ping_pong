name: Daily Ping Report

on:
  schedule:
    - cron: "0 12 * * *"  # Âè∞ÁÅ£ÊôÇÈñì 20:00 (UTC+8)
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq msmtp

      - name: Fetch today's workflow runs
        id: get_runs
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          echo "üîç Today is: $TODAY (UTC)"

          # API Ë´ãÊ±ÇÂ¢ûÂä†ÈåØË™§ËôïÁêÜ
          RESP=$(curl -s -f \
            -H "Authorization: token ${{ secrets.REPORT_PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/157651133/runs?per_page=100")
          
          if [ $? -ne 0 ]; then
            echo "‚ùå API Ë´ãÊ±ÇÂ§±ÊïóÔºåË´ãÊ™¢Êü• PAT Ê¨äÈôêÊàñÁ∂≤Ë∑ØÈÄ£Á∑ö"
            exit 1
          fi

          echo "$RESP" > runs.json
          
          # Âº∑Âåñ jq ÈÅéÊøæÈÇèËºØ
          TOTAL=$(jq '[ (.workflow_runs? // [])[] | select(.created_at? | startswith("'"$TODAY"'")) ] | length' runs.json)
          SUCCESS=$(jq '[ (.workflow_runs? // [])[] | select(.created_at? | startswith("'"$TODAY"'") and .conclusion? == "success") ] | length' runs.json)
          FAIL=$(jq '[ (.workflow_runs? // [])[] | select(.created_at? | startswith("'"$TODAY"'") and .conclusion? == "failure") ] | length' runs.json)

          # ÊõøÊèõÊ£ÑÁî®ÁöÑ set-output
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "fail=$FAIL" >> $GITHUB_OUTPUT

          # ÁîüÊàêÂ†±Âëä
          echo "üìÖ Ping Report for $TODAY (UTC+8):" > report.md
          echo "- Total runs: $TOTAL" >> report.md
          echo "- Success:    $SUCCESS" >> report.md
          echo "- Failures:   $FAIL" >> report.md
          echo "" >> report.md
          echo "‚úÖ Success runs:" >> report.md
          jq -r '(.workflow_runs? // [])[] | select(.created_at? | startswith("'"$TODAY"'") and .conclusion? == "success") | .html_url' runs.json >> report.md

      - name: Show report
        run: cat report.md

      - name: Email report
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          # ÈÖçÁΩÆ msmtp
          cat << EOF > ~/.msmtprc
          defaults
          auth           on
          tls            on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt
          account        gmail
          host           smtp.gmail.com
          port           587
          from           $EMAIL_USER
          user           $EMAIL_USER
          password       $EMAIL_PASS
          account default : gmail
          EOF
          chmod 600 ~/.msmtprc

          # ÁôºÈÄÅÈÉµ‰ª∂
          {
            echo "To: $EMAIL_TO"
            echo "From: $EMAIL_USER"
            echo "Subject: Daily Ping Report - $(date -u +"%Y-%m-%d")"
            echo "Content-Type: text/plain"
            echo ""
            cat report.md
          } | msmtp --debug --from=default -t