name: Daily Ping Report

on:
  schedule:
    - cron: "0 12 * * *" # 台灣時間 20:00
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq msmtp

      - name: Fetch today's workflow runs
        id: get_runs
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          echo "🔍 Today is: $TODAY (UTC)"

          RESP=$(curl -s \
            -H "Authorization: token ${{ secrets.REPORT_PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/157651133/runs?per_page=100")
          echo "$RESP" > runs.json
          echo "$RESP" | jq '.' > debug.json
          cat debug.json

          TOTAL=$(jq '[.workflow_runs // [] | select(type=="object") | select(.created_at | strings | startswith("'"$TODAY"'"))] | length' runs.json)
          SUCCESS=$(jq '[.workflow_runs // [] | select(type=="object") | select(.created_at | strings | startswith("'"$TODAY"'") and .conclusion=="success")] | length' runs.json)
          FAIL=$(jq '[.workflow_runs // [] | select(type=="object") | select(.created_at | strings | startswith("'"$TODAY"'") and .conclusion=="failure")] | length' runs.json)

          echo "::set-output name=total::$TOTAL"
          echo "::set-output name=success::$SUCCESS"
          echo "::set-output name=fail::$FAIL"

          echo "📅 Ping Report for $TODAY (UTC+8):" > report.md
          echo "- Total runs: $TOTAL" >> report.md
          echo "- Success:    $SUCCESS" >> report.md
          echo "- Failures:   $FAIL" >> report.md
          echo "" >> report.md
          echo "✅ Success runs:" >> report.md
          jq -r '.workflow_runs[] | select(type=="object") | select(.created_at | strings | startswith("'"$TODAY"'") and .conclusion=="success") | .html_url' runs.json >> report.md

      - name: Show report
        run: cat report.md

      - name: Email report
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          echo "defaults" > ~/.msmtprc
          echo "auth           on" >> ~/.msmtprc
          echo "tls            on" >> ~/.msmtprc
          echo "tls_trust_file /etc/ssl/certs/ca-certificates.crt" >> ~/.msmtprc
          echo "account        gmail" >> ~/.msmtprc
          echo "host           smtp.gmail.com" >> ~/.msmtprc
          echo "port           587" >> ~/.msmtprc
          echo "from           $EMAIL_USER" >> ~/.msmtprc
          echo "user           $EMAIL_USER" >> ~/.msmtprc
          echo "password       $EMAIL_PASS" >> ~/.msmtprc
          echo "account default : gmail" >> ~/.msmtprc
          chmod 600 ~/.msmtprc

          {
            echo "To: $EMAIL_TO"
            echo "From: $EMAIL_USER"
            echo "Subject: Daily Ping Report - $(date -u +"%Y-%m-%d")"
            echo "Content-Type: text/plain"
            echo ""
            cat report.md
          } | msmtp --debug --from=default -t
