name: Daily Ping Report

on:
  schedule:
    - cron: "0 12 * * *"  # 台灣時間 20:00 (UTC+8)
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq msmtp

      - name: Fetch workflow runs
        id: get_runs
        env:
          GITHUB_TOKEN: ${{ secrets.REPORT_PAT }}
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          echo "🔍 Fetching runs for: $TODAY (UTC)"

          API_URL="https://api.github.com/repos/${{ github.repository }}/actions/workflows/157651133/runs?created=$TODAY&per_page=100"
          
          # 添加詳細錯誤日誌
          curl -v -s -f \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL" > runs.json 2> curl-debug.log

          if [ $? -ne 0 ]; then
            echo "::error::API Request Failed. Debug Info:"
            cat curl-debug.log
            exit 1
          fi

      - name: Generate report
        run: |
          # 精確統計計算
          TOTAL=$(jq '.workflow_runs | length' runs.json)
          SUCCESS=$(jq '[.workflow_runs[] | select(.conclusion == "success")] | length' runs.json)
          FAIL=$(jq '[.workflow_runs[] | select(.conclusion == "failure")] | length' runs.json)

          # 擷取時間段（轉換為台灣時間）
          START_TIME=$(date -u -d "1 day ago +8 hours" +"%Y-%m-%d %H:%M")
          END_TIME=$(date -u -d "+8 hours" +"%Y-%m-%d %H:%M")

          # 報告標題與統計摘要
          echo "<h1>📊 Ping 執行報告 - $(date -u -d "+8 hours" +"%Y-%m-%d")</h1>" > report.html
          echo "<p>擷取時間段：${START_TIME} 至 ${END_TIME} (台灣時間)</p>" >> report.html
          echo "<p><strong>成功：${SUCCESS} 次</strong></p>" >> report.html
          echo "<p><strong>失敗：${FAIL} 次</strong></p>" >> report.html
          echo "<p><strong>總執行：${TOTAL} 次</strong></p>" >> report.html

          # 完整記錄
          echo "<h2>查看完整記錄 (共 ${TOTAL} 筆)</h2>" >> report.html
          echo "<table style='width:100%; border-collapse:collapse; text-align:left; font-family:Arial, sans-serif;'>" >> report.html
          echo "<thead>" >> report.html
          echo "<tr style='background-color:#f2f2f2;'>" >> report.html
          echo "<th style='padding:8px; border:1px solid #ddd;'>編號</th>" >> report.html
          echo "<th style='padding:8px; border:1px solid #ddd;'>時間 (台灣時間)</th>" >> report.html
          echo "<th style='padding:8px; border:1px solid #ddd;'>狀態</th>" >> report.html
          echo "</tr>" >> report.html
          echo "</thead>" >> report.html
          echo "<tbody>" >> report.html

          jq -r '
            .workflow_runs[] |
            [
              "#\(.run_number)",
              (.run_started_at | sub("\\.[0-9]+Z$"; "Z") | fromdateiso8601 + (8*3600) | strftime("%Y-%m-%d %H:%M")),
              (if .conclusion == "success" then "🟢 成功" else "🔴 失敗" end),
              (if .conclusion == "failure" then "<a href=\"\(.html_url)\" style=\"color:#e74c3c;\">連結</a>" else "" end)
            ] | @tsv
          ' runs.json | while IFS=$'\t' read -r run_number time status link; do
            echo "<tr>" >> report.html
            echo "<td style='padding:8px; border:1px solid #ddd;'>${run_number}</td>" >> report.html
            echo "<td style='padding:8px; border:1px solid #ddd;'>${time}</td>" >> report.html
            echo "<td style='padding:8px; border:1px solid #ddd;'>${status} ${link}</td>" >> report.html
            echo "</tr>" >> report.html
          done

          echo "</tbody>" >> report.html
          echo "</table>" >> report.html

      - name: Send email
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          # 建立 msmtp 配置檔案
          echo "account default" > ~/.msmtprc
          echo "host smtp.gmail.com" >> ~/.msmtprc
          echo "port 587" >> ~/.msmtprc
          echo "auth on" >> ~/.msmtprc
          echo "user $EMAIL_USER" >> ~/.msmtprc
          echo "password $EMAIL_PASS" >> ~/.msmtprc
          echo "tls on" >> ~/.msmtprc
          echo "tls_starttls on" >> ~/.msmtprc
          echo "from $EMAIL_USER" >> ~/.msmtprc  # 添加 envelope-from 地址
          echo "logfile ~/.msmtp.log" >> ~/.msmtprc
          chmod 600 ~/.msmtprc

          # 修正統計數據
          BODY=$(sed -e 's/🟢/<span style="color:#2ecc71;font-weight:bold;">●<\/span>/g' \
                     -e 's/🔴/<span style="color:#e74c3c;font-weight:bold;">●<\/span>/g' \
                     -e 's/<h1>/<h1 style="color:#34495e; font-size:24px; margin-bottom:16px;">/g' \
                     -e 's/<h2>/<h2 style="color:#2c3e50; font-size:20px; margin-bottom:12px;">/g' \
                     -e 's/<p>/<p style="margin:8px 0;">/g' \
                     report.html)

          {
            echo "To: $EMAIL_TO"
            echo "From: $EMAIL_USER"
            echo "Subject: [Ping報告] $(date -u +"%Y-%m-%d")"
            echo "Content-Type: text/html; charset=UTF-8"
            echo ""
            echo "<!DOCTYPE html>"
            echo "<html>"
            echo "<head><meta name='viewport' content='width=device-width, initial-scale=1'></head>"
            echo "<body style='font-family:-apple-system, BlinkMacSystemFont, sans-serif; max-width:600px; margin:0 auto; padding:16px; line-height:1.6;'>"
            echo "<div style='background:#f9f9f9; padding:16px; border-radius:8px;'>"
            echo "$BODY"
            echo "</div>"
            echo "</body></html>"
          } | msmtp -t