name: Daily Ping Report

on:
  schedule:
    - cron: "0 12 * * *"  # å°ç£æ™‚é–“ 20:00 (UTC+8)
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq msmtp

      - name: Fetch today's workflow runs
        id: get_runs
        env:
          GITHUB_TOKEN: ${{ secrets.REPORT_PAT }}
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          echo "ğŸ” Today is: $TODAY (UTC)"

          # API è«‹æ±‚
          API_URL="https://api.github.com/repos/${{ github.repository }}/actions/workflows/157651133/runs?created=$TODAY&per_page=100"
          curl -s -f \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL" > runs.json

          if [ $? -ne 0 ]; then
            echo "::error::API è«‹æ±‚å¤±æ•—"
            exit 1
          fi

          # è¨ˆç®—çµ±è¨ˆæ•¸æ“š
          TOTAL=$(jq '[.workflow_runs // [] | length] | max' runs.json)
          SUCCESS=$(jq '[.workflow_runs // [] | map(select(.conclusion == "success")) | length] | max' runs.json)
          FAIL=$(jq '[.workflow_runs // [] | map(select(.conclusion == "failure")) | length] | max' runs.json)

          # è¼¸å‡ºè®Šæ•¸
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "fail=$FAIL" >> $GITHUB_OUTPUT

      - name: Generate report
        run: |
          # åŸºæœ¬å ±å‘Š
          echo "## ğŸ“Š æ¯æ—¥ Ping å ±å‘Š - $(date -u +"%Y-%m-%d") (UTC+8)" > report.md
          echo "### çµ±è¨ˆæ‘˜è¦" >> report.md
          echo "- ğŸŸ¢ æˆåŠŸæ¬¡æ•¸: ${SUCCESS:-0}" >> report.md
          echo "- ğŸ”´ å¤±æ•—æ¬¡æ•¸: ${FAIL:-0}" >> report.md
          echo "- ğŸ”µ ç¸½åŸ·è¡Œæ¬¡æ•¸: ${TOTAL:-0}" >> report.md
          echo "" >> report.md

          # å°ç£æ™‚é–“è©³ç´°è¡¨æ ¼
          echo "### ğŸ•’ åŸ·è¡Œæ™‚é–“æ˜ç´°" >> report.md
          echo "| é‹è¡Œç·¨è™Ÿ | å•Ÿå‹•æ™‚é–“ | ç‹€æ…‹ | æŒçºŒæ™‚é–“ | è©³ç´°é€£çµ |" >> report.md
          echo "|----------|----------|------|----------|----------|" >> report.md
          
          jq -r '
            (.workflow_runs // [])[] 
            | [
              "#\(.run_number)",
              (
                (.run_started_at | sub("\\.[0-9]+Z$"; "Z") | fromdateiso8601 + (8*3600)) 
                | strftime("%m/%d %H:%M:%S")
              ),
              (if .conclusion == "success" then "ğŸŸ¢" else "ğŸ”´" end),
              "\(( (.updated_at | fromdateiso8601) - (.run_started_at | fromdateiso8601) ) | floor /60) åˆ†",
              "[æŸ¥çœ‹](\(.html_url))"
              ] 
            | join("|")
          ' runs.json | while read -r line; do
            echo "|$line|" >> report.md
          done || echo "| - | - | - | - | ç„¡åŸ·è¡Œç´€éŒ„ |" >> report.md

          # æ·»åŠ åˆ†éš”ç·š
          echo "" >> report.md
          echo "---" >> report.md

          # æˆåŠŸé‹è¡Œè©³ç´°è³‡è¨Š
          echo "### âœ… æˆåŠŸé‹è¡Œåˆ—è¡¨" >> report.md
          jq -r '(.workflow_runs // [])[] 
            | select(.conclusion == "success")
            | "- [é‹è¡Œ #\(.run_number)]\(.html_url) (\(.updated_at | sub("\\.[0-9]+Z$"; "Z") | fromdateiso8601 | strftime("%H:%M:%S")))"
          ' runs.json >> report.md || echo "æœ¬æ—¥ç„¡æˆåŠŸé‹è¡Œç´€éŒ„" >> report.md

      - name: Show report
        run: cat report.md

      - name: Email report
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          # é…ç½® msmtp
          cat << EOF > ~/.msmtprc
          defaults
          auth           on
          tls            on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt
          account        gmail
          host           smtp.gmail.com
          port           587
          from           $EMAIL_USER
          user           $EMAIL_USER
          password       $EMAIL_PASS
          account default : gmail
          EOF
          chmod 600 ~/.msmtprc

          # ç™¼é€éƒµä»¶
          {
            echo "To: $EMAIL_TO"
            echo "From: $EMAIL_USER"
            echo "Subject: [Ping å ±å‘Š] $(date -u +"%Y-%m-%d") æ¯æ—¥åŸ·è¡Œæ‘˜è¦"
            echo "Content-Type: text/html"
            echo ""
            echo "<pre style='font-family: Consolas, monospace;'>"
            cat report.md | sed 's/#/##/g'  # èª¿æ•´æ¨™é¡Œå±¤ç´šé©åˆéƒµä»¶é¡¯ç¤º
            echo "</pre>"
          } | msmtp --debug --from=default -t